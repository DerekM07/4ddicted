name: Release
on:
  push:
    branches:
      - main
    tags:
      - "v*"
      - "rc*"
      - "beta*"
      - "alpha*"
env:
  WOLVENKIT_CORE_VERSION: '8.11.1'
  WOLVENKIT_CLI_VERSION: '1.11.0'
  DOTNET_VERSION: '7.0.x'
  IS_DRAFT: ${{ startsWith(github.ref_name, 'beta') || startsWith(github.ref_name, 'alpha') }}

jobs:
  bundle-mod:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Just
        uses: extractions/setup-just@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '${{ env.DOTNET_VERSION }}'
      - name: Setup WolvenKit CLI
        run: |
          C:\msys64\usr\bin\wget.exe https://github.com/WolvenKit/WolvenKit/releases/download/"${{ env.WOLVENKIT_CORE_VERSION }}"/"${{ env.WOLVENKIT_ARTIFACT }}"
          7z x "${{ env.WOLVENKIT_ARTIFACT }}"
          dotnet tool install -g wolvenkit.cli
        env:
          WOLVENKIT_ARTIFACT: WolvenKit.Console-${{ env.WOLVENKIT_CLI_VERSION }}.zip
      - name: Bundle files
        run: just ci 'Addicted-windows-latest-${{ github.ref_name }}'
        env:
          WK_CLI: cp77tools
      - name: Zip files
        if: ${{ startsWith(github.event.ref, 'refs/tags') }}
        uses: thedoctor0/zip-release@0.7.6
        with:
          type: 'zip'
          filename: 'Addicted-windows-latest-${{ github.ref_name }}.zip'
          directory: ./mod-latest
          path: .
          recursive_exclusions: ${{ (env.IS_DRAFT && 'Debug.reds debug.reds') || '' }}
      - name: Upload artifact
        if: ${{ startsWith(github.event.ref, 'refs/tags') }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-latest-${{ github.ref_name }}-artifact
          path: mod-latest/Addicted-windows-latest-${{ github.ref_name }}.zip
          if-no-files-found: error
  bundle-translations:
    runs-on: windows-latest
    strategy:
      matrix:
        locale:
          - en-us
          - fr-fr
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Just
        uses: extractions/setup-just@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Bundle files
        run: just bundle 'translation-${{ matrix.locale }}-latest' "${{ matrix.locale }}"
      - name: Zip files
        uses: thedoctor0/zip-release@0.7.6
        with:
          type: 'zip'
          filename: 'Addicted-windows-latest-${{ matrix.locale }}-${{ github.ref_name }}.zip'
          directory: translation-${{ matrix.locale }}-latest
          path: .
          recursive_exclusions: ${{ (env.IS_DRAFT && 'Debug.reds debug.reds') || '' }}
      - name: Upload translations
        if: ${{ startsWith(github.event.ref, 'refs/tags') }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-latest-${{ github.ref_name }}-translations-${{ matrix.locale }}
          path: translation-${{ matrix.locale }}-latest/Addicted-windows-latest-${{ matrix.locale }}-${{ github.ref_name }}.zip
          if-no-files-found: error
  release:
    if: ${{ startsWith(github.event.ref, 'refs/tags') }}
    runs-on: windows-latest
    strategy:
      matrix:
        locale:
          - en-us
          - fr-fr
    needs: [bundle-mod, bundle-translations]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-latest-${{ github.ref_name }}-artifact
          path: release
      - name: Download ${{ matrix.locale }} translations
        uses: actions/download-artifact@v4
        with:
          name: windows-latest-${{ github.ref_name }}-translations-${{ matrix.locale }}
          path: release
      - name: Create release ${{ github.ref_name }}
        uses: ncipollo/release-action@v1
        with:
          artifacts: "release/*.zip"
          draft: ${{ env.IS_DRAFT }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifactErrorsFailBuild: true
